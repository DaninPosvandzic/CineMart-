<!-- product-page.component.html -->
<div class="product-detail-page" *ngIf="product">

  <!-- Hero Section with Product Image Background -->
  <div class="hero-backdrop" [style.background-image]="'url(' + product.imageUrl + ')'">
    <div class="hero-overlay"></div>
  </div>

  <div class="content-wrapper">

    <!-- Main Product Card -->
    <div class="product-card">

      <!-- Product Image -->
      <div class="image-container">
        <img [src]="product.imageUrl" [alt]="product.name" class="product-image">
        <div class="stock-badge" [class.in-stock]="product.stockQuantity > 0" [class.out-of-stock]="product.stockQuantity === 0">
          <mat-icon>{{ product.stockQuantity > 0 ? 'check_circle' : 'cancel' }}</mat-icon>
          <span>{{ product.stockQuantity > 0 ? 'Na skladištu' : 'Nema na skladištu' }}</span>
        </div>
      </div>

      <!-- Product Info -->
      <div class="product-info">

        <!-- Title & Meta -->
        <div class="product-header">
          <h1 class="product-title">{{ product.name }}</h1>
          <div class="product-meta">
            <span class="meta-item category-tag">
              <mat-icon>category</mat-icon>
              {{ product.categoryName }}
            </span>
            <span class="meta-item" *ngIf="product.averageRating">
              <mat-icon>star</mat-icon>
              {{ product.averageRating | number: '1.1-1' }} rating
            </span>
          </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
          <div class="stat-item">
            <mat-icon class="stat-icon price-icon">payments</mat-icon>
            <div class="stat-content">
              <span class="stat-value">${{ product.price | number: '1.2-2' }}</span>
              <span class="stat-label">Cijena</span>
            </div>
          </div>
          <div class="stat-divider"></div>
          <div class="stat-item">
            <mat-icon class="stat-icon" [class.stock-ok]="product.stockQuantity > 0" [class.stock-empty]="product.stockQuantity === 0">
              inventory_2
            </mat-icon>
            <div class="stat-content">
              <span class="stat-value">{{ product.stockQuantity }}</span>
              <span class="stat-label">Na skladištu</span>
            </div>
          </div>
          <div class="stat-divider"></div>
          <div class="stat-item">
            <mat-icon class="stat-icon rating">star</mat-icon>
            <div class="stat-content">
              <span class="stat-value">{{ product.averageRating | number: '1.1-1' }}</span>
              <span class="stat-label">Ocjena</span>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div class="description-section">
          <h3 class="section-title">Opis proizvoda</h3>
          <p class="description-text">
            {{ product.description || 'Nema dostupnog opisa za ovaj proizvod.' }}
          </p>
        </div>

        <!-- Quantity Selector -->
        <div class="quantity-section">
          <h3 class="section-title">Količina</h3>
          <div class="quantity-selector">
            <button class="qty-btn" (click)="decreaseQuantity()" [disabled]="quantity <= 1">
              <mat-icon>remove</mat-icon>
            </button>
            <input
              type="number"
              class="qty-input"
              [(ngModel)]="quantity"
              [min]="1"
              [max]="product.stockQuantity"
              (change)="validateQuantity()">
            <button class="qty-btn" (click)="increaseQuantity()" [disabled]="quantity >= product.stockQuantity">
              <mat-icon>add</mat-icon>
            </button>
          </div>
          <p class="qty-hint" *ngIf="product.stockQuantity < 5 && product.stockQuantity > 0">
            ⚠️ Samo {{ product.stockQuantity }} komada preostalo
          </p>
        </div>

        <!-- Price Summary -->
        <div class="price-summary">
          <div class="summary-row">
            <span class="summary-label">Cijena po komadu:</span>
            <span class="summary-value">${{ product.price | number: '1.2-2' }}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Količina:</span>
            <span class="summary-value">{{ quantity }}</span>
          </div>
          <div class="summary-divider"></div>
          <div class="summary-row total">
            <span class="summary-label">Ukupno:</span>
            <span class="summary-value">${{ getTotalPrice() | number: '1.2-2' }}</span>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-section">
          <button
            class="action-btn primary"
            (click)="addToCart()"
            [disabled]="product.stockQuantity === 0 || loadingCart">
            <mat-icon *ngIf="!loadingCart">shopping_cart</mat-icon>
            <mat-icon *ngIf="loadingCart" class="spinning">refresh</mat-icon>
            <span>{{ loadingCart ? 'Dodavanje...' : (product.stockQuantity === 0 ? 'Nema na skladištu' : 'Dodaj u košaricu') }}</span>
          </button>


          <!-- Admin Buttons -->
          <button
            *ngIf="isAdmin()"
            class="action-btn admin-edit"
            (click)="openEditModal()">
            <mat-icon>edit</mat-icon>
            <span>Uredi proizvod</span>
          </button>
          <button
            *ngIf="isAdmin()"
            class="action-btn admin-delete"
            (click)="showDeleteModal = true">
            <mat-icon>delete</mat-icon>
            <span>Obriši</span>
          </button>
        </div>

      </div>
    </div>

    <!-- Additional Information Tabs -->
    <div class="info-tabs">
      <div class="tab-header">
        <button
          class="tab-btn"
          [class.active]="activeTab === 'details'"
          (click)="switchTab('details')">
          <mat-icon>info</mat-icon>
          Detalji
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab === 'shipping'"
          (click)="switchTab('shipping')">
          <mat-icon>local_shipping</mat-icon>
          Dostava
        </button>
        <button class="tab-btn">
          <mat-icon>star</mat-icon>
          Recenzije
        </button>
        <button class="tab-btn">
          <mat-icon>shopping_bag</mat-icon>
          Slični proizvodi
        </button>
      </div>

      <!-- Tab Content: Details -->
      <div class="tab-content" [class.active]="activeTab === 'details'">
        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">Kategorija</span>
            <span class="detail-value">{{ product.categoryName }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Dostupnost</span>
            <span class="detail-value" [class.text-success]="product.stockQuantity > 0" [class.text-danger]="product.stockQuantity === 0">
              {{ product.stockQuantity > 0 ? 'Na skladištu (' + product.stockQuantity + ')' : 'Nema na skladištu' }}
            </span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Cijena</span>
            <span class="detail-value">${{ product.price | number: '1.2-2' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Prosječna ocjena</span>
            <span class="detail-value">{{ product.averageRating | number: '1.1-1' }} / 5.0</span>
          </div>
        </div>
      </div>

      <!-- Tab Content: Shipping -->
      <div class="tab-content" [class.active]="activeTab === 'shipping'">
        <div class="shipping-info">
          <div class="shipping-option">
            <mat-icon class="shipping-icon">local_shipping</mat-icon>
            <div class="shipping-details">
              <h4>Standardna dostava</h4>
              <p>Besplatna dostava za narudžbe preko $50</p>
              <span class="shipping-time">3-5 radnih dana</span>
            </div>
          </div>
          <div class="shipping-option">
            <mat-icon class="shipping-icon">flash_on</mat-icon>
            <div class="shipping-details">
              <h4>Ekspresna dostava</h4>
              <p>Brza dostava za dodatnih $9.99</p>
              <span class="shipping-time">1-2 radna dana</span>
            </div>
          </div>
          <div class="shipping-option">
            <mat-icon class="shipping-icon">store</mat-icon>
            <div class="shipping-details">
              <h4>Preuzimanje u trgovini</h4>
              <p>Besplatno preuzimanje u našoj trgovini</p>
              <span class="shipping-time">Odmah dostupno</span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- DELETE CONFIRM MODAL -->
  <div class="modal-backdrop" *ngIf="showDeleteModal" (click)="cancelDelete()">
    <div class="modal-card delete-modal" (click)="$event.stopPropagation()">
      <mat-icon class="modal-icon delete">warning</mat-icon>
      <h2>Potvrdi brisanje</h2>
      <p>Jeste li sigurni da želite obrisati "<strong>{{ product?.name }}</strong>"? Ova akcija se ne može poništiti.</p>
      <div class="modal-actions">
        <button class="btn-modal cancel" (click)="cancelDelete()">
          Otkaži
        </button>
        <button class="btn-modal delete" (click)="confirmDelete()">
          <mat-icon>delete</mat-icon>
          Obriši proizvod
        </button>
      </div>
    </div>
  </div>

  <!-- EDIT PRODUCT MODAL -->
  <div class="modal-backdrop" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-card edit-modal" (click)="$event.stopPropagation()">
      <mat-icon class="modal-icon edit">edit</mat-icon>
      <h2>Uredi proizvod</h2>

      <form (ngSubmit)="submitEdit()" #editForm="ngForm">

        <div class="form-group">
          <label>Naziv</label>
          <input
            type="text"
            name="name"
            [(ngModel)]="editProduct.name"
            required />
        </div>

        <div class="form-group">
          <label>Opis</label>
          <textarea
            name="description"
            [(ngModel)]="editProduct.description">
          </textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Cijena ($)</label>
            <input
              type="number"
              name="price"
              [(ngModel)]="editProduct.price"
              step="0.01"
              required />
          </div>

          <div class="form-group">
            <label>Stanje zaliha</label>
            <input
              type="number"
              name="stockQuantity"
              [(ngModel)]="editProduct.stockQuantity"
              min="0"
              required />
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-modal cancel" (click)="closeEditModal()">
            Otkaži
          </button>
          <button type="submit" class="btn-modal save" [disabled]="editForm.invalid">
            <mat-icon>save</mat-icon>
            Spremi promjene
          </button>
        </div>
      </form>
    </div>
  </div>

</div>

<ng-template #loadingOrError>
  <div class="loading-container" *ngIf="isLoading">
    <mat-icon class="spinning">refresh</mat-icon>
    <p>Učitavanje proizvoda...</p>
  </div>
  <div class="error-container" *ngIf="!isLoading && errorMessage">
    <mat-icon>error_outline</mat-icon>
    <p>{{ errorMessage }}</p>
    <button class="action-btn secondary" routerLink="/products">
      <mat-icon>arrow_back</mat-icon>
      Povratak na proizvode
    </button>
  </div>
</ng-template>
